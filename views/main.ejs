<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Feed - SNS App</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="/script.js" defer></script>
</head>
<body>
    <h1>Welcome, <%= user.id %></h1>

    <div class="nav">
        <a href="/newpost">+ Create New Post</a>
        <a href="/logout" style="color: #666;">Logout</a>
    </div>

    <div class="feed">
        <% if (posts.length === 0) { %>
            <p>No posts yet. Be the first to share something!</p>
        <% } %>

        <% posts.forEach(post => { %>
            <div class="post">
                <div class="post-header">
                    <strong>@<%= post.author %></strong>
                    <span><%= new Date(post.createdAt).toLocaleString() %></span>
                </div>

                <% 
                    const isLong = post.content.split('\n').length > 5 || post.content.length > 300; 
                %>

                <div class="post-content <%= isLong ? 'collapsed' : '' %>" id="content-<%= post._id %>"><%= post.content %></div>

                <% if (isLong) { %>
                    <button class="btn-toggle-view">
                        Show more
                    </button>
                <% } %>

                <div class="post-actions">
                    <button 
                        class="btn-like <%= post.likedBy.includes(user.id) ? 'liked' : '' %>" 
                        id="btn-like-<%= post._id %>"
                        onclick="toggleLike('<%= post._id %>')"
                    >
                        <i class="<%= post.likedBy.includes(user.id) ? 'fa-solid' : 'fa-regular' %> fa-heart"></i>
                        <span id="count-<%= post._id %>"><%= post.likes %></span>
                    </button>

                    <% if (user.id === post.author || user.roles.includes('admin')) { %>
                        <form action="/deletePost" method="POST" class="delete-form" style="display:inline;">
                                <input type="hidden" name="postId" value="<%= post._id %>">
                                <button type="submit" class="btn-delete">Delete</button>
                        </form>
                    <% } %>
                </div>
            </div>
        <% }) %>
    </div>
</body>
</html>