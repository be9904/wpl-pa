<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Feed - SNS App</title>
    <link rel="stylesheet" href="/style.css">
    <script src="/script.js" defer></script>
</head>
<body>
    <h1>Welcome, <%= user.id %></h1>

    <div class="nav">
        <a href="/newpost">+ Create New Post</a>
        <a href="/logout" style="color: #666;">Logout</a>
    </div>

    <div class="feed">
        <% if (posts.length === 0) { %>
            <p>No posts yet. Be the first to share something!</p>
        <% } %>

        <% posts.forEach(post => { %>
            <div class="post">
                <div class="post-header">
                    <strong>@<%= post.author %></strong>
                    <span><%= new Date(post.createdAt).toLocaleString() %></span>
                </div>

                <% 
                    const isLong = post.content.split('\n').length > 5 || post.content.length > 300; 
                %>

                <div class="post-content <%= isLong ? 'collapsed' : '' %>" id="content-<%= post._id %>"><%= post.content %></div>

                <% if (isLong) { %>
                    <button class="btn-toggle-view" onclick="togglePost('<%= post._id %>', this)">
                        Show more
                    </button>
                <% } %>

                <div class="post-actions">
                    <form action="/likePost" method="POST" style="display:inline;">
                        <input type="hidden" name="postId" value="<%= post._id %>">
                        
                        <% if (post.likedBy.includes(user.id)) { %>
                            <button type="submit" class="btn-like" style="background-color: #007BFF; color: white;">
                                ♥ Liked (<%= post.likes %>)
                            </button>
                        <% } else { %>
                            <button type="submit" class="btn-like">
                                ♡ Like (<%= post.likes %>)
                            </button>
                        <% } %>
                    </form>

                    <% if (user.id === post.author || user.roles.includes('admin')) { %>
                        <form action="/deletePost" method="POST" style="display:inline;" 
                            onsubmit="return confirm('Are you sure you want to delete this post? This action cannot be undone.');">
                                <input type="hidden" name="postId" value="<%= post._id %>">
                                <button type="submit" class="btn-delete">Delete</button>
                        </form>
                    <% } %>
                </div>
            </div>
        <% }) %>
    </div>
</body>
</html>